name: gh-pages

on:

    push:
        branches: [ "main" ]

jobs:

    github-pages-publish:
        runs-on: ubuntu-latest
        needs:   code-gen
        steps:
            -   name: Checkout Latest Changes
                uses: actions/checkout@v2
                with:
                    path:        ${{ github.workspace }}/main
                    ref:         ${{ github.ref }}
                    fetch-depth: 0
            -   name: Checkout gh-pages Branch
                uses: actions/checkout@v2
                with:
                    path:        ${{ github.workspace }}/gh-pages
                    ref:         gh-pages
                    fetch-depth: 0

            -   name: Setup Git Config
                run:  |
                      git config --global user.name "github-actions[bot]"
                      git config --global user.email "github-actions[bot]@users.noreply.github.com"
            -   name:              Get Commit SHA from main
                working-directory: ${{ github.workspace }}/main
                run:               |
                                   COMMIT_SHA=$(git rev-parse HEAD)
                                   echo "COMMIT_SHA=${COMMIT_SHA}" >> ${GITHUB_ENV}
            -   name:              Commit Changes to gh-pages Branch
                working-directory: ${{ github.workspace }}/gh-pages
                run:               |
                                   git rm -rf . || true
                                   rm -rf ${{ github.workspace }}/main/.git/
                                   cp -a ${{ github.workspace }}/main/. ${{ github.workspace }}/gh-pages/
                                   git add .
                                   git diff-index --quiet HEAD || git commit -m "GitHub Pages - ${{ env.COMMIT_SHA }}"
                                   git push origin gh-pages --force
